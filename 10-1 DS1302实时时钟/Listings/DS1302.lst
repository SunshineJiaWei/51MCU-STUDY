C51 COMPILER V9.60.7.0   DS1302                                                            05/17/2024 09:22:23 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\DS1302.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE DS1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\DS
                    -1302.lst) OBJECT(.\Objects\DS1302.obj)

line level    source

   1          #include <REGX52.H>
   2          
   3          // å¼•è„šå®šä¹‰
   4          sbit DS1302_SCLK = P3^6;
   5          sbit DS1302_IO = P3^4;
   6          sbit DS1302_CE = P3^5;
   7          
   8          // å¯„å­˜å™¨å†™å…¥åœ°å€å®šä¹‰
   9          #define DS1302_SECOND   0x80
  10          #define DS1302_MINUTE   0x82
  11          #define DS1302_HOUR             0x84
  12          #define DS1302_DATE             0x86
  13          #define DS1302_MONTH    0x88
  14          #define DS1302_DAY              0x8A
  15          #define DS1302_YEAR             0x8C
  16          #define DS1302_WP               0x8E
  17          
  18          // æ—¶é—´æ•°æ®ï¼šå¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ã€æ˜ŸæœŸ
  19          unsigned char DS1302_Time[] = {24,1,1,23,59,55,1};
  20          
  21          /**
  22                  * @brief        DS1302åˆå§‹åŒ–
  23                  * @param        æ— 
  24                  * @retval       æ— 
  25          */
  26          void DS1302_Init()
  27          {
  28   1              DS1302_SCLK = 0;
  29   1              DS1302_IO = 0;
  30   1      }
  31          
  32          /**
  33                  * @brief        DS1302å†™å…¥ä¸€ä¸ªå­—èŠ‚
  34                  * @param        Commandï¼šå†™å…¥çš„å‘½ä»¤å­—æ®µ
  35                  * @param        Dataï¼šå†™å…¥çš„æ•°æ®
  36                  * @retval       æ— 
  37          */
  38          void DS1302_WriteByte(unsigned char Command, Data)
  39          {
  40   1              unsigned char i;
  41   1              DS1302_CE = 1;
  42   1                
  43   1              for(i = 0;i < 8;i++)
  44   1              {
  45   2                      DS1302_IO = Command & (0x01 << i);
  46   2                      DS1302_SCLK = 1;
  47   2                      DS1302_SCLK = 0;
  48   2              }
  49   1              
  50   1              for(i = 0;i < 8;i++)
  51   1              {
  52   2                      DS1302_IO = Data & (0x01 << i);
  53   2                      DS1302_SCLK = 1;
  54   2                      DS1302_SCLK = 0;
C51 COMPILER V9.60.7.0   DS1302                                                            05/17/2024 09:22:23 PAGE 2   

  55   2              }
  56   1              
  57   1              DS1302_CE = 0;
  58   1      }
  59          
  60          /**
  61                  * @brief        DS1302è¯»å–ä¸€ä¸ªå­—èŠ‚
  62                  * @param        Commandï¼šå†™å…¥çš„å‘½ä»¤å­—æ®µ
  63                  * @retval       è¯»å‡ºçš„æ•°æ®
  64          */
  65          unsigned char DS1302_ReadByte(unsigned char Command)
  66          {
  67   1              unsigned char i, Data = 0x00;
  68   1              Command |= 0x01; // å°†å†™æŒ‡ä»¤å˜æˆè¯»æŒ‡ä»¤ï¼Œæœ€ä½ä¸ºç½®1
  69   1              DS1302_CE = 1;
  70   1              
  71   1              for(i = 0;i < 8;i++)
  72   1              {
  73   2                      DS1302_IO = Command & (0x01 << i);
  74   2                      DS1302_SCLK = 0;
  75   2                      DS1302_SCLK = 1;
  76   2              }
  77   1              
  78   1              for(i = 0;i < 8;i++)
  79   1              {
  80   2                      DS1302_SCLK  = 1;
  81   2                      DS1302_SCLK = 0;
  82   2                      // è¯»ï¼šIOå£è¯»å–Dataå­—èŠ‚æ•°æ®ï¼Œä¸€ä½ä¸€ä½è¯»ï¼Œè‹¥æ­¤æ—¶ä¸º1ï¼Œåˆ™å°†å¯¹åº”ä½çš„Dataçš„å€¼ç½®
             -1
  83   2                      if(DS1302_IO){Data |= (0x01 << i);}
  84   2              }
  85   1              
  86   1              DS1302_CE = 0;
  87   1              //è¯»å–åå°†IOè®¾ç½®ä¸º0ï¼Œå¦åˆ™è¯»å‡ºçš„æ•°æ®ä¼šå‡ºé”™
  88   1              DS1302_IO = 0;  
  89   1              return Data;
  90   1      }
  91          
  92          /**
  93                  * @brief        BCDç¼–ç è½¬æˆåè¿›åˆ¶æ•°
  94                  * @param        BCDï¼šéœ€è¦è½¬æ¢çš„BCDç¼–ç 
  95                  * @retval       BCDçš„åè¿›åˆ¶æ•°
  96          */
  97          unsigned char BCD_TO_DEC(unsigned char BCD)
  98          {
  99   1              unsigned char DEC = BCD / 16 * 10 + BCD % 16;
 100   1              return DEC;
 101   1      }
 102          
 103          /**
 104                  * @brief        åè¿›åˆ¶è½¬æ¢æˆBCDç¼–ç 
 105                  * @param        DECï¼šéœ€è¦è½¬æ¢çš„åè¿›åˆ¶æ•°
 106                  * @retval       åè¿›åˆ¶æ•°çš„BCDç¼–ç 
 107          */
 108          unsigned char DEC_TO_BCD(unsigned char DEC)
 109          {
 110   1              unsigned char BCD = DEC / 10 * 16 + DEC % 10;
 111   1              return BCD;
 112   1      }
 113          
 114          /**
 115                  * @brief        DS1302è®¾ç½®æ—¶é—´ï¼Œå‡½æ•°è°ƒç”¨åï¼ŒDS1302_Timeæ•°ç»„ä¸­çš„å€¼ä¼šå†™å…¥åˆ°DS1302ä¸­
C51 COMPILER V9.60.7.0   DS1302                                                            05/17/2024 09:22:23 PAGE 3   

 116                  * @param        æ— 
 117                  * @retval       æ— 
 118          */
 119          void DS1302_SetTime()
 120          {
 121   1              // å…³é—­å†™ä¿æŠ¤
 122   1              DS1302_WriteByte(DS1302_WP,0x80); 
 123   1              DS1302_WriteByte(DS1302_YEAR,DEC_TO_BCD(DS1302_Time[0]));
 124   1              DS1302_WriteByte(DS1302_MONTH,DEC_TO_BCD(DS1302_Time[1]));
 125   1              DS1302_WriteByte(DS1302_DATE,DEC_TO_BCD(DS1302_Time[2]));
 126   1              DS1302_WriteByte(DS1302_HOUR,DEC_TO_BCD(DS1302_Time[3]));
 127   1              DS1302_WriteByte(DS1302_MINUTE,DEC_TO_BCD(DS1302_Time[4]));
 128   1              DS1302_WriteByte(DS1302_SECOND,DEC_TO_BCD(DS1302_Time[5]));
 129   1              DS1302_WriteByte(DS1302_DAY,DEC_TO_BCD(DS1302_Time[6]));
 130   1              //  æ‰“å¼€å†™ä¿æŠ¤
 131   1              DS1302_WriteByte(DS1302_WP,0x00);
 132   1      }
 133          
 134          /**
 135                  * @brief        DS1302è¯»å–æ—¶é—´ï¼Œå‡½æ•°è°ƒç”¨åï¼Œè¯»å–åˆ°çš„BCDç¼–ç å€¼åè½¬æ¢æˆåè¿›åˆ¶æ•°å­˜å…¥æ—
             -¶é—´æ•°ç»„ä¸­
 136                  * @param        æ— 
 137                  * @retval       æ— 
 138          */
 139          void DS1302_ReadTime()
 140          {
 141   1              DS1302_Time[0] = BCD_TO_DEC(DS1302_ReadByte(DS1302_YEAR));
 142   1              DS1302_Time[1] = BCD_TO_DEC(DS1302_ReadByte(DS1302_MONTH));
 143   1              DS1302_Time[2] = BCD_TO_DEC(DS1302_ReadByte(DS1302_DATE));
 144   1              DS1302_Time[3] = BCD_TO_DEC(DS1302_ReadByte(DS1302_HOUR));
 145   1              DS1302_Time[4] = BCD_TO_DEC(DS1302_ReadByte(DS1302_MINUTE));
 146   1              DS1302_Time[5] = BCD_TO_DEC(DS1302_ReadByte(DS1302_SECOND));
 147   1              DS1302_Time[6] = BCD_TO_DEC(DS1302_ReadByte(DS1302_DAY));
 148   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    372    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
